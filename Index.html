<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPIN SPON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Kanit', sans-serif; background: #0a0a0a; color: #e5e5e5; }
        .gold-grad { background: linear-gradient(135deg, #FFD700 0%, #FDB931 50%, #C08209 100%); }
        .gold-text { background: linear-gradient(to bottom, #FFD700, #FDB931); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass { background: rgba(30, 30, 30, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 215, 0, 0.1); }
        .wheel-shadow { filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.3)); }
        
        /* Pointer */
        .pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #ef4444; /* Red Arrow */
            z-index: 20; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-x-hidden">

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] bg-black">
        <div class="w-full max-w-sm p-8 bg-neutral-900 rounded-2xl border border-yellow-600/30 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 gold-grad"></div>
            <h1 class="text-4xl font-black text-center mb-2 gold-text tracking-widest">GOLDEN 888</h1>
            <p class="text-center text-gray-500 mb-8 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏ù‡∏≤‡∏Å-‡∏ñ‡∏≠‡∏ô 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
            
            <div class="space-y-4">
                <div class="relative">
                    <i class="fas fa-user absolute left-4 top-3.5 text-yellow-600"></i>
                    <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" class="w-full pl-10 p-3 bg-black border border-gray-700 rounded-lg focus:border-yellow-500 outline-none text-white">
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-4 top-3.5 text-yellow-600"></i>
                    <input type="password" id="pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full pl-10 p-3 bg-black border border-gray-700 rounded-lg focus:border-yellow-500 outline-none text-white">
                </div>
                <button onclick="login()" class="w-full py-3 rounded-lg font-bold text-black gold-grad hover:brightness-110 transition shadow-lg mt-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <div class="flex justify-between text-xs text-gray-400 mt-4">
                    <span onclick="register()" class="cursor-pointer hover:text-yellow-500">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</span>
                    <span class="cursor-pointer hover:text-yellow-500">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</span>
                </div>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden flex-1 flex flex-col max-w-md mx-auto w-full bg-neutral-900 shadow-2xl min-h-screen relative pb-20">
        
        <div class="sticky top-0 z-30 bg-neutral-900/90 backdrop-blur border-b border-white/10 p-4 flex justify-between items-center shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full border-2 border-yellow-500 overflow-hidden bg-black flex items-center justify-center">
                    <i class="fas fa-user-astronaut text-yellow-500 text-lg"></i>
                </div>
                <div>
                    <div id="user-display" class="text-xs text-gray-400">Guest</div>
                    <div class="text-lg font-bold text-white flex items-center gap-1">
                        <span class="text-yellow-500">‡∏ø</span> <span id="balance-display">0.00</span>
                    </div>
                </div>
            </div>
            <button onclick="openModal('deposit')" class="gold-grad text-black px-4 py-1.5 rounded-full text-xs font-bold shadow-lg hover:scale-105 transition">
                <i class="fas fa-plus-circle"></i> ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
            </button>
        </div>

        <div class="bg-black py-1 overflow-hidden border-b border-white/5 relative">
            <div class="whitespace-nowrap animate-marquee text-xs text-yellow-400/80 px-4" id="marquee-text">
                üì¢ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà GOLDEN 888 ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏á‡∏•‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ó‡∏µ‡πà‡πÅ‡∏ü‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î! ‡πÅ‡∏ï‡∏Å‡∏á‡πà‡∏≤‡∏¢ ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á 100%
            </div>
        </div>

        <div class="p-4">
            <h3 class="text-white text-sm font-bold mb-3 border-l-4 border-yellow-500 pl-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h3>
            <div id="wheel-list" class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                <div class="w-32 h-20 bg-gray-800 rounded animate-pulse"></div>
            </div>
        </div>

        <div class="flex-1 flex flex-col items-center relative mt-2 px-4">
            <div class="text-center mb-4">
                <h2 id="w-title" class="text-2xl font-bold gold-text">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°</h2>
                <p class="text-xs text-gray-400">‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡πà‡∏ô: <span id="w-cost" class="text-yellow-500 font-bold">0</span> ‡∏ö‡∏≤‡∏ó</p>
            </div>

            <div class="relative w-[320px] h-[320px] wheel-shadow">
                <div class="pointer"></div>
                <canvas id="canvas" width="640" height="640" class="w-full h-full transition-transform duration-[5000ms] ease-[cubic-bezier(0.25,0.1,0.25,1)]"></canvas>
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-gradient-to-br from-black to-gray-800 rounded-full border-4 border-yellow-500 flex items-center justify-center z-10 shadow-xl">
                    <i class="fas fa-crown text-yellow-500 text-xl"></i>
                </div>
            </div>

            <button id="spin-btn" onclick="spin()" disabled class="mt-8 bg-gray-800 text-gray-500 w-full max-w-[200px] py-3 rounded-full font-bold text-lg shadow-lg transition transform active:scale-95 border border-white/10">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
            </button>
        </div>

        <div class="fixed bottom-0 w-full max-w-md bg-black border-t border-white/10 flex justify-around p-2 pb-4 text-[10px] text-gray-500 z-40">
            <button onclick="setTab('home')" class="flex flex-col items-center gap-1 text-yellow-500 w-16">
                <i class="fas fa-home text-xl"></i> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
            </button>
            <button onclick="openModal('deposit')" class="flex flex-col items-center gap-1 hover:text-white w-16">
                <i class="fas fa-wallet text-xl"></i> ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            <button onclick="openModal('withdraw')" class="flex flex-col items-center gap-1 hover:text-white w-16">
                <i class="fas fa-hand-holding-usd text-xl"></i> ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            <button onclick="openModal('history')" class="flex flex-col items-center gap-1 hover:text-white w-16">
                <i class="fas fa-history text-xl"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            </button>
            <button onclick="logout()" class="flex flex-col items-center gap-1 hover:text-white w-16">
                <i class="fas fa-sign-out-alt text-xl"></i> ‡∏≠‡∏≠‡∏Å
            </button>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-end sm:items-center justify-center p-4">
        <div class="bg-neutral-800 w-full max-w-sm rounded-t-2xl sm:rounded-2xl border border-white/10 flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/50 rounded-t-2xl">
                <h3 id="modal-title" class="font-bold text-white text-lg">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="p-4 overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>

    <div id="win-popup" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="text-center animate-bounce">
            <h1 class="text-6xl mb-4">üéâ</h1>
            <h2 class="text-4xl font-black gold-text mb-2">YOU WIN!</h2>
            <p class="text-white text-xl">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</p>
            <div id="win-amount" class="text-5xl font-bold text-yellow-400 my-4 drop-shadow-[0_0_10px_rgba(255,215,0,0.8)]">1,000</div>
            <p class="text-gray-400 text-sm mb-6">‡∏ö‡∏≤‡∏ó</p>
            <button onclick="closeWin()" class="bg-white text-black px-8 py-3 rounded-full font-bold shadow-lg hover:scale-105 transition">‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyABuBrdprpiN32ZD4cSCiSslkYbRfnWGgE",
            authDomain: "namba-fe57a.firebaseapp.com",
            databaseURL: "https://namba-fe57a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "namba-fe57a",
            appId: "1:340416568750:web:bb0a58ee618978bc107c3f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        let user = null, userData = {}, currentWheel = null, isSpinning = false;
        let wheels = {};

        // --- 2. AUTHENTICATION ---
        auth.onAuthStateChanged(u => {
            if(u) {
                user = u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('user-display').innerText = u.email;
                
                // Realtime Balance
                db.ref(`users/${u.uid}`).on('value', s => {
                    userData = s.val() || { balance: 0 };
                    document.getElementById('balance-display').innerText = userData.balance.toLocaleString('en-US', {minimumFractionDigits: 2});
                });
                
                // Load System Data
                loadWheels();
                loadSystem();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        const login = () => auth.signInWithEmailAndPassword(getVal('email'), getVal('pass')).catch(e=>alert(e.message));
        const register = () => auth.createUserWithEmailAndPassword(getVal('email'), getVal('pass'))
            .then(c => db.ref(`users/${c.user.uid}`).set({ email: c.user.email, balance: 0, created: Date.now() }))
            .catch(e=>alert(e.message));
        const logout = () => auth.signOut();
        const getVal = (id) => document.getElementById(id).value;

        // --- 3. SYSTEM & WHEEL ---
        function loadSystem() {
            db.ref('system/announcement').on('value', s => {
                if(s.val()) document.getElementById('marquee-text').innerHTML = `üì¢ ${s.val()}`;
            });
        }

        function loadWheels() {
            db.ref('wheels').on('value', s => {
                wheels = s.val() || {};
                const list = document.getElementById('wheel-list');
                list.innerHTML = '';
                
                let firstKey = null;
                Object.keys(wheels).forEach((key, i) => {
                    if(i===0) firstKey = key;
                    const w = wheels[key];
                    list.innerHTML += `
                        <div onclick="selectWheel('${key}')" class="flex-shrink-0 w-32 bg-neutral-800 p-2 rounded-lg border border-white/10 hover:border-yellow-500 cursor-pointer transition relative overflow-hidden group">
                            <div class="text-xs text-gray-400">‡πÄ‡∏Å‡∏°</div>
                            <div class="font-bold text-white truncate text-sm group-hover:text-yellow-400">${w.name}</div>
                            <div class="mt-1 text-xs text-yellow-500 font-bold">‡∏ø${w.cost}</div>
                            <div class="absolute bottom-0 right-0 opacity-10 text-4xl text-white"><i class="fas fa-dharmachakra"></i></div>
                        </div>
                    `;
                });
                if(firstKey && !currentWheel) selectWheel(firstKey);
            });
        }

        function selectWheel(key) {
            if(isSpinning) return;
            currentWheel = wheels[key];
            currentWheel.id = key;
            
            document.getElementById('w-title').innerText = currentWheel.name;
            document.getElementById('w-cost').innerText = currentWheel.cost;
            
            // Enable Button
            const btn = document.getElementById('spin-btn');
            btn.disabled = false;
            btn.innerText = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°";
            btn.className = "mt-8 w-full max-w-[200px] py-3 rounded-full font-bold text-lg shadow-lg transition transform active:scale-95 gold-grad text-black hover:brightness-110";

            drawWheel();
            resetRotation();
        }

        function drawWheel() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const segments = currentWheel.segments || [];
            const len = segments.length;
            const arc = (2 * Math.PI) / len;
            const radius = 320; 

            ctx.clearRect(0,0,640,640);
            ctx.translate(320, 320);
            // Canvas default 0 deg is 3 o'clock.
            // We draw normally.

            segments.forEach((seg, i) => {
                const angle = i * arc;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, angle, angle + arc);
                ctx.fillStyle = seg.color;
                ctx.fill();
                ctx.stroke();

                // Text
                ctx.save();
                ctx.rotate(angle + arc / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 40px Kanit";
                ctx.shadowColor="rgba(0,0,0,0.5)";
                ctx.shadowBlur=4;
                ctx.fillText(seg.label, radius - 40, 15);
                ctx.restore();
            });
            ctx.translate(-320, -320);
        }

        function resetRotation() {
            const canvas = document.getElementById('canvas');
            canvas.style.transition = 'none';
            canvas.style.transform = `rotate(0deg)`;
        }

        // --- 4. GAME LOGIC (FIXED MATH) ---
        function spin() {
            if(isSpinning) return;
            if(userData.balance < currentWheel.cost) return alert('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï');

            isSpinning = true;
            document.getElementById('spin-btn').disabled = true;
            document.getElementById('spin-btn').classList.add('grayscale');

            // 4.1 Determine Result based on Weight
            const segments = currentWheel.segments;
            const totalWeight = segments.reduce((sum, s) => sum + (parseInt(s.weight)||1), 0);
            let random = Math.floor(Math.random() * totalWeight);
            let resultIndex = 0;
            for(let i=0; i<segments.length; i++) {
                random -= (parseInt(segments[i].weight)||1);
                if(random < 0) { resultIndex = i; break; }
            }

            // 4.2 Deduct Balance
            db.ref(`users/${user.uid}/balance`).set(userData.balance - currentWheel.cost);

            // 4.3 Calculate Rotation (THE FIX)
            // Goal: Center of segment[resultIndex] must be at TOP (270 deg / -90 deg relative to 3 o'clock)
            // Arc per segment = 360 / N
            // Angle of segment start = Index * Arc
            // Center of segment = (Index * Arc) + (Arc / 2)
            // To bring this Center to Top (270 deg):
            // Rotation = 270 - CenterOfSegment
            // Add full spins (360 * 5)
            
            const arcDeg = 360 / segments.length;
            const segmentCenter = (resultIndex * arcDeg) + (arcDeg / 2);
            let targetRotate = 270 - segmentCenter; 
            
            // Adjust to be positive spin
            const spins = 360 * 8; // 8 rounds
            const finalRotate = spins + targetRotate;

            // 4.4 Animate
            const canvas = document.getElementById('canvas');
            canvas.style.transition = 'transform 5s cubic-bezier(0.2, 0.8, 0.2, 1)';
            canvas.style.transform = `rotate(${finalRotate}deg)`;

            // 4.5 Process Result
            setTimeout(() => {
                isSpinning = false;
                const won = segments[resultIndex];
                let winAmount = 0;
                
                if(won.type === 'cash') winAmount = parseInt(won.value);
                
                // Add Win
                if(winAmount > 0) {
                    db.ref(`users/${user.uid}/balance`).transaction(b => (b||0) + winAmount);
                    document.getElementById('win-amount').innerText = winAmount.toLocaleString();
                    document.getElementById('win-popup').classList.remove('hidden');
                } else {
                    alert('‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡∏à‡πâ‡∏≤! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    document.getElementById('spin-btn').disabled = false;
                    document.getElementById('spin-btn').classList.remove('grayscale');
                }

                // Log History
                db.ref('game_logs').push({
                    uid: user.uid,
                    wheel: currentWheel.name,
                    bet: currentWheel.cost,
                    result: won.label,
                    win: winAmount,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

            }, 5000);
        }

        function closeWin() {
            document.getElementById('win-popup').classList.add('hidden');
            document.getElementById('spin-btn').disabled = false;
            document.getElementById('spin-btn').classList.remove('grayscale');
            resetRotation();
        }

        // --- 5. WALLET & MODALS ---
        function openModal(type) {
            document.getElementById('modal').classList.remove('hidden');
            const content = document.getElementById('modal-content');
            const title = document.getElementById('modal-title');
            
            if(type === 'deposit') {
                title.innerText = "‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô (‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)";
                db.ref('system/bank_info').once('value', s => {
                    content.innerHTML = `
                        <div class="bg-neutral-900 p-4 rounded border border-yellow-500/30 mb-4">
                            <p class="text-xs text-gray-400">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</p>
                            <p class="text-white text-sm whitespace-pre-wrap mt-1">${s.val() || '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'}</p>
                        </div>
                        <label class="text-xs text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <input type="number" id="tx-amt" class="w-full bg-black border border-gray-700 p-3 rounded text-white mb-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100">
                        <label class="text-xs text-gray-400">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ï‡∏≤‡∏°‡∏™‡∏•‡∏¥‡∏õ</label>
                        <input type="text" id="tx-ref" class="w-full bg-black border border-gray-700 p-3 rounded text-white mb-4" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12:30">
                        <button onclick="sendTx('deposit')" class="w-full bg-green-600 hover:bg-green-500 py-3 rounded font-bold text-white">‡πÅ‡∏à‡πâ‡∏á‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button>
                    `;
                });
            } else if(type === 'withdraw') {
                title.innerText = "‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ";
                content.innerHTML = `
                    <label class="text-xs text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô</label>
                    <input type="number" id="tx-amt" class="w-full bg-black border border-gray-700 p-3 rounded text-white mb-2">
                    <label class="text-xs text-gray-400">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ - ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£)</label>
                    <textarea id="tx-ref" class="w-full bg-black border border-gray-700 p-3 rounded text-white mb-4 h-24"></textarea>
                    <button onclick="sendTx('withdraw')" class="w-full bg-red-600 hover:bg-red-500 py-3 rounded font-bold text-white">‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                    <p class="text-xs text-gray-500 mt-2 text-center">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó</p>
                `;
            } else if(type === 'history') {
                title.innerText = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î";
                content.innerHTML = '<div class="space-y-2" id="log-list">Loading...</div>';
                db.ref('game_logs').orderByChild('uid').equalTo(user.uid).limitToLast(20).once('value', s => {
                    const d = document.getElementById('log-list');
                    d.innerHTML = '';
                    if(!s.exists()) { d.innerHTML='<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>'; return; }
                    const arr = [];
                    s.forEach(c => arr.push(c.val()));
                    arr.reverse().forEach(log => {
                        const isWin = log.win > 0;
                        d.innerHTML += `
                            <div class="flex justify-between items-center bg-black/50 p-3 rounded border border-white/5">
                                <div>
                                    <div class="font-bold text-white">${log.wheel}</div>
                                    <div class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleTimeString()}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold ${isWin?'text-green-400':'text-red-400'}">${isWin ? '+'+log.win : '-'+log.bet}</div>
                                    <div class="text-[10px] text-gray-400">${log.result}</div>
                                </div>
                            </div>
                        `;
                    });
                });
            }
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function sendTx(type) {
            const amt = parseInt(document.getElementById('tx-amt').value);
            const ref = document.getElementById('tx-ref').value;
            
            if(!amt || !ref) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            if(type === 'withdraw' && amt > userData.balance) return alert('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠');

            if(type === 'withdraw') {
                // Deduct first for withdraw
                db.ref(`users/${user.uid}/balance`).set(userData.balance - amt);
            }

            db.ref('transactions').push({
                uid: user.uid,
                email: user.email,
                type: type,
                amount: amt,
                details: ref,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            alert('‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
            closeModal();
        }

        // Set Tab visual helper
        function setTab(t) {
           // Visual switch logic only
        }

    </script>
</body>
</html>
