<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lucky Wheel Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background: #0f0c29; background: linear-gradient(to right, #24243e, #302b63, #0f0c29); color: white; overflow-x: hidden; }
        .neon-text { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #ff00de, 0 0 30px #ff00de; }
        .wheel-container { position: relative; width: 320px; height: 320px; margin: 0 auto; filter: drop-shadow(0 0 15px rgba(255,255,255,0.2)); }
        #canvas { width: 100%; height: 100%; transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); transform: rotate(0deg); }
        .pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 40px; height: 50px; background: #fbbf24; clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5)); }
        .modal { transition: opacity 0.3s ease-in-out; }
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]">
        <div class="w-full max-w-sm p-8 glass rounded-2xl text-center">
            <h1 class="text-4xl font-bold mb-2 neon-text">SPIN WIN</h1>
            <p class="text-gray-400 mb-6">‡∏´‡∏°‡∏∏‡∏ô‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏ß‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
            <input type="email" id="email" placeholder="Email" class="w-full p-3 mb-3 bg-white/10 rounded border border-white/20 text-white outline-none focus:border-pink-500">
            <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-6 bg-white/10 rounded border border-white/20 text-white outline-none focus:border-pink-500">
            <button onclick="login()" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button onclick="register()" class="mt-4 text-sm text-gray-400 hover:text-white">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <div id="app-ui" class="hidden flex-1 flex flex-col max-w-md mx-auto w-full min-h-screen bg-black/40 shadow-2xl relative">
        
        <div class="p-4 flex justify-between items-center glass m-2 rounded-xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center text-xl">ü¶Ñ</div>
                <div>
                    <div id="u-email" class="text-xs text-gray-300">Loading...</div>
                    <div class="font-bold text-yellow-400">‡∏ø <span id="u-balance" class="text-xl">0</span></div>
                </div>
            </div>
            <button onclick="openWallet()" class="bg-white/20 px-3 py-1 rounded-lg text-xs hover:bg-white/30">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡∏Ñ‡πå</button>
        </div>

        <div class="px-4 mt-2">
            <h3 class="text-gray-400 text-xs mb-2 uppercase tracking-widest">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h3>
            <div id="wheel-list" class="flex gap-3 overflow-x-auto pb-4 scrollbar-hide">
                <div class="animate-pulse bg-white/10 w-32 h-20 rounded-xl flex-shrink-0"></div>
            </div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center relative my-4">
            <h2 id="wheel-name" class="text-2xl font-bold mb-4 neon-text text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</h2>
            
            <div class="wheel-container">
                <div class="pointer"></div>
                <canvas id="canvas" width="640" height="640"></canvas>
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-white rounded-full shadow-lg flex items-center justify-center z-20 border-4 border-purple-500">
                    <span class="text-purple-900 font-bold text-xs">SPIN</span>
                </div>
            </div>

            <div id="play-controls" class="mt-8 text-center hidden">
                <p class="text-gray-300 text-sm mb-2">‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡πà‡∏ô: <span id="wheel-cost" class="text-yellow-400 font-bold">0</span> ‡∏ö‡∏≤‡∏ó</p>
                <button onclick="spin()" id="spin-btn" class="bg-gradient-to-b from-yellow-400 to-yellow-600 text-black font-bold text-xl px-12 py-4 rounded-full shadow-lg shadow-yellow-500/50 hover:scale-105 transition transform active:scale-95">
                    ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏•‡∏¢!
                </button>
            </div>
        </div>

        <div class="p-4 text-center text-gray-500 text-xs">
            <button onclick="auth.signOut()" class="text-red-500">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

    </div>

    <div id="wallet-modal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-end sm:items-center justify-center">
        <div class="bg-gray-900 w-full max-w-md h-[80vh] sm:h-auto sm:rounded-2xl rounded-t-3xl p-6 relative flex flex-col">
            <button onclick="document.getElementById('wallet-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
            
            <h2 class="text-xl font-bold mb-6 flex gap-2">üí≥ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô <span class="text-yellow-500">‡∏ø<span id="w-bal">0</span></span></h2>

            <div class="flex bg-gray-800 p-1 rounded-lg mb-4">
                <button onclick="setWalletTab('dep')" id="tab-dep" class="flex-1 py-2 rounded text-sm bg-gray-700 text-white">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button>
                <button onclick="setWalletTab('wit')" id="tab-wit" class="flex-1 py-2 rounded text-sm text-gray-400">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                <button onclick="setWalletTab('his')" id="tab-his" class="flex-1 py-2 rounded text-sm text-gray-400">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>

            <div id="wallet-content" class="flex-1 overflow-y-auto">
                </div>
        </div>
    </div>

    <div id="result-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur">
        <div class="bg-white text-black p-8 rounded-3xl text-center shadow-2xl animate-bounce">
            <h2 class="text-4xl font-black text-purple-600 mb-2">YAY!</h2>
            <p class="text-gray-500">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</p>
            <div id="result-val" class="text-5xl font-bold my-4 text-yellow-500">1000</div>
            <button onclick="closeResult()" class="bg-black text-white px-8 py-3 rounded-full font-bold">‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const config = {
            apiKey: "AIzaSyABuBrdprpiN32ZD4cSCiSslkYbRfnWGgE", // ‡πÉ‡∏™‡πà KEY ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            authDomain: "namba-fe57a.firebaseapp.com",
            databaseURL: "https://namba-fe57a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "namba-fe57a",
            appId: "1:340416568750:web:bb0a58ee618978bc107c3f"
        };
        firebase.initializeApp(config);
        const auth = firebase.auth();
        const db = firebase.database();
        
        let user = null, userData = {}, currentWheel = null, wheels = {};
        let isSpinning = false;

        // --- AUTH & INIT ---
        auth.onAuthStateChanged(u => {
            if(u) {
                user = u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-ui').classList.remove('hidden');
                document.getElementById('u-email').innerText = u.email;
                
                db.ref(`users/${u.uid}`).on('value', s => {
                    userData = s.val() || {balance:0};
                    document.querySelectorAll('#u-balance, #w-bal').forEach(e => e.innerText = userData.balance.toLocaleString());
                });

                loadWheels();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        const login = () => auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(alert);
        const register = () => auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
            .then(c => db.ref(`users/${c.user.uid}`).set({email: c.user.email, balance: 0})).catch(alert);

        // --- WHEEL SYSTEM ---
        function loadWheels() {
            db.ref('wheels').on('value', s => {
                const list = document.getElementById('wheel-list');
                list.innerHTML = '';
                wheels = s.val() || {};
                
                Object.keys(wheels).forEach((key, idx) => {
                    const w = wheels[key];
                    const activeClass = (idx===0) ? 'border-purple-500 bg-purple-900/50' : 'border-white/10 bg-white/5';
                    list.innerHTML += `
                        <div onclick="selectWheel('${key}')" class="cursor-pointer border ${activeClass} hover:bg-white/10 p-3 rounded-xl min-w-[120px] flex flex-col justify-between transition group">
                            <div class="text-sm font-bold text-white group-hover:text-purple-300">${w.name}</div>
                            <div class="text-xs text-yellow-400 mt-1">‡∏ø${w.cost}</div>
                        </div>
                    `;
                    if(idx===0 && !currentWheel) selectWheel(key);
                });
            });
        }

        function selectWheel(key) {
            currentWheel = wheels[key];
            currentWheel.id = key;
            document.getElementById('wheel-name').innerText = currentWheel.name;
            document.getElementById('wheel-cost').innerText = currentWheel.cost.toLocaleString();
            document.getElementById('play-controls').classList.remove('hidden');
            
            // Draw Wheel
            drawWheel();
            
            // Reset rotation
            document.getElementById('canvas').style.transform = `rotate(0deg)`;
            document.getElementById('canvas').style.transition = 'none';
        }

        function drawWheel() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const segments = currentWheel.segments || [];
            const len = segments.length;
            const arc = (2 * Math.PI) / len;
            const radius = 320; 

            ctx.clearRect(0,0,640,640);
            ctx.translate(320, 320);

            segments.forEach((seg, i) => {
                const angle = i * arc;
                ctx.beginPath();
                ctx.arc(0, 0, radius, angle, angle + arc);
                ctx.lineTo(0, 0);
                ctx.fillStyle = seg.color;
                ctx.fill();

                // Text
                ctx.save();
                ctx.rotate(angle + arc / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 40px Kanit";
                ctx.fillText(seg.label, radius - 40, 15);
                ctx.restore();
            });
            ctx.translate(-320, -320); // Reset
        }

        function spin() {
            if(isSpinning) return;
            if(userData.balance < currentWheel.cost) return alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πà‡∏ß‡∏ô!");

            isSpinning = true;
            document.getElementById('spin-btn').disabled = true;
            document.getElementById('spin-btn').classList.add('opacity-50');

            // 1. Client-Side Calculation based on weights (Simulate Server RNG)
            // Logic: Sum total weights -> Random -> Find segment
            const segments = currentWheel.segments || [];
            let totalWeight = segments.reduce((sum, seg) => sum + (parseInt(seg.weight)||1), 0);
            let random = Math.floor(Math.random() * totalWeight);
            let resultIndex = -1;
            
            for(let i=0; i<segments.length; i++) {
                random -= (parseInt(segments[i].weight)||1);
                if(random < 0) {
                    resultIndex = i;
                    break;
                }
            }

            // 2. Calculate Angle
            const segmentArc = 360 / segments.length;
            // Target angle needs to land on resultIndex. 
            // Canvas 0 deg is at 3 o'clock. We need to account for rotation.
            // Let's rely on adding extra spins + specific stop point.
            // If result is index 0, we want index 0 to be at top (270deg) or handle pointer pos.
            // Pointer is at TOP. 
            
            // Math: To get Index I to top:
            // Rotate = - (Index * Arc) - (Arc/2) - 90deg (adjustment)
            const stopAngle = 360 * 5 + (360 - (resultIndex * segmentArc) - (segmentArc/2)); // 5 spins min
            
            // 3. Deduct Balance
            db.ref(`users/${user.uid}/balance`).set(userData.balance - currentWheel.cost);

            // 4. Animate
            const canvas = document.getElementById('canvas');
            canvas.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
            canvas.style.transform = `rotate(${stopAngle}deg)`;

            setTimeout(() => {
                isSpinning = false;
                document.getElementById('spin-btn').disabled = false;
                document.getElementById('spin-btn').classList.remove('opacity-50');
                
                const wonItem = segments[resultIndex];
                let reward = 0;
                
                if(wonItem.type === 'cash') reward = parseInt(wonItem.value);
                // if type multiplier logic can be added here
                
                if(reward > 0) {
                    db.ref(`users/${user.uid}/balance`).set(userData.balance + reward); // Add win (already deducted cost)
                    // Or logic: balance - cost + reward. (Done separately above for safety)
                }

                document.getElementById('result-val').innerText = (reward > 0) ? `‡∏ø${reward}` : '‡πÄ‡∏Å‡∏•‡∏∑‡∏≠!';
                document.getElementById('result-modal').classList.remove('hidden');

            }, 5000);
        }

        function closeResult() {
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('canvas').style.transition = 'none';
            document.getElementById('canvas').style.transform = `rotate(${0}deg)`; // Reset visual if needed or keep it
        }

        // --- WALLET UI ---
        function openWallet() { 
            document.getElementById('wallet-modal').classList.remove('hidden');
            setWalletTab('dep');
        }
        function setWalletTab(t) {
            ['dep','wit','his'].forEach(x => {
                document.getElementById(`tab-${x}`).className = `flex-1 py-2 rounded text-sm ${x===t ? 'bg-gray-700 text-white' : 'text-gray-400'}`;
            });
            const content = document.getElementById('wallet-content');
            
            if(t === 'dep') {
                db.ref('system/bank_info').once('value', s => {
                    content.innerHTML = `
                        <div class="space-y-4 pt-4">
                            <div class="bg-blue-900/30 p-4 rounded border border-blue-500/30">
                                <p class="text-xs text-blue-300">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</p>
                                <p class="text-white whitespace-pre-line">${s.val() || 'Loading...'}</p>
                            </div>
                            <input type="number" id="tx-amt" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="w-full p-3 bg-gray-800 rounded border border-gray-600 text-white">
                            <input type="text" id="tx-info" placeholder="‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ / ‡∏™‡∏•‡∏¥‡∏õ" class="w-full p-3 bg-gray-800 rounded border border-gray-600 text-white">
                            <button onclick="sendTx('deposit')" class="w-full bg-green-600 py-3 rounded font-bold hover:bg-green-500">‡πÅ‡∏à‡πâ‡∏á‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button>
                        </div>
                    `;
                });
            } else if (t === 'wit') {
                content.innerHTML = `
                    <div class="space-y-4 pt-4">
                        <input type="number" id="tx-amt" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏≠‡∏ô" class="w-full p-3 bg-gray-800 rounded border border-gray-600 text-white">
                        <input type="text" id="tx-info" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ - ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£" class="w-full p-3 bg-gray-800 rounded border border-gray-600 text-white">
                        <button onclick="sendTx('withdraw')" class="w-full bg-red-600 py-3 rounded font-bold hover:bg-red-500">‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                    </div>
                `;
            } else {
                // History
                content.innerHTML = '<div class="pt-4 space-y-2" id="his-list">Loading...</div>';
                db.ref('transactions').orderByChild('uid').equalTo(user.uid).limitToLast(10).once('value', s => {
                    const list = document.getElementById('his-list');
                    list.innerHTML = '';
                    if(!s.exists()) { list.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>'; return; }
                    
                    const arr = [];
                    s.forEach(c => arr.push(c.val()));
                    arr.reverse().forEach(t => {
                        const color = t.type==='deposit' ? 'text-green-400' : 'text-red-400';
                        const statusColor = t.status==='approved' ? 'text-green-500' : (t.status==='rejected'?'text-red-500':'text-yellow-500');
                        list.innerHTML += `
                            <div class="bg-gray-800 p-3 rounded flex justify-between items-center text-sm">
                                <div>
                                    <div class="font-bold ${color}">${t.type==='deposit'?'‡∏ù‡∏≤‡∏Å':'‡∏ñ‡∏≠‡∏ô'} ${t.amount}</div>
                                    <div class="text-xs text-gray-500">${new Date(t.timestamp).toLocaleDateString()}</div>
                                </div>
                                <div class="${statusColor} font-bold uppercase text-xs">${t.status}</div>
                            </div>
                        `;
                    });
                });
            }
        }

        function sendTx(type) {
            const amt = parseInt(document.getElementById('tx-amt').value);
            const info = document.getElementById('tx-info').value;
            if(!amt || !info) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            if(type==='withdraw' && amt > userData.balance) return alert("‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠");

            if(type==='withdraw') db.ref(`users/${user.uid}/balance`).set(userData.balance - amt);

            db.ref('transactions').push({
                uid: user.uid, email: user.email, amount: amt, details: info, type: type, status: 'pending', timestamp: Date.now()
            });
            alert("‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            setWalletTab('his');
        }

    </script>
</body>
</html>
