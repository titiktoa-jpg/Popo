<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REWARD HUB | ศูนย์รวมไอเทมพรีเมียม</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid #e2e8f0; }
        .item-card { transition: all 0.3s ease; border: 1px solid #f1f5f9; }
        .item-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; }
        .btn-primary { background: #2563eb; color: white; transition: 0.2s; }
        .btn-primary:hover { background: #1d4ed8; }
        .loading-skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background: #e2e8f0; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        /* Scrollbar Hide */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="glass-nav fixed w-full z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">R</div>
                    <span class="font-semibold text-xl tracking-tight text-slate-800">Reward<span class="text-blue-600">Hub</span></span>
                </div>

                <div class="hidden md:flex flex-1 max-w-lg mx-8 relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="global-search" onkeyup="handleSearch()" 
                           class="block w-full pl-10 pr-3 py-2 border border-gray-200 rounded-full leading-5 bg-slate-50 placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition sm:text-sm" 
                           placeholder="ค้นหาไอเทม, เกม, หรือของรางวัล...">
                </div>

                <div class="flex items-center gap-3">
                    <div id="user-menu" class="hidden flex items-center gap-3">
                        <button onclick="openHistory()" class="text-sm font-medium text-slate-600 hover:text-blue-600 transition">
                            <i class="fas fa-history mr-1"></i> ประวัติ
                        </button>
                        <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold border border-blue-200" id="user-avatar">U</div>
                        <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition text-sm">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                    <button id="login-btn" onclick="openModal('auth-modal')" class="btn-primary px-5 py-2 rounded-full text-sm font-medium shadow-sm hover:shadow-md">
                        เข้าสู่ระบบ
                    </button>
                </div>
            </div>
        </div>
        
        <div class="md:hidden px-4 pb-3">
            <input type="text" id="mobile-search" onkeyup="handleSearch(true)"
                   class="block w-full px-4 py-2 border border-gray-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                   placeholder="ค้นหาไอเทม...">
        </div>
    </nav>

    <main class="flex-1 pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto w-full">
        
        <div class="mb-10 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-700 p-8 text-white shadow-xl relative overflow-hidden">
            <div class="absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-white opacity-10 rounded-full blur-3xl"></div>
            <div class="relative z-10">
                <h1 class="text-3xl font-bold mb-2">ยินดีต้อนรับสู่ศูนย์กลางไอเทม</h1>
                <p class="text-blue-100 mb-6 max-w-xl">แลกรับไอเทมเกม บัตรเติมเงิน และของรางวัลมากมายได้ฟรี เพียงทำตามเงื่อนไข ระบบอัตโนมัติ 24 ชม.</p>
                <div class="flex gap-3">
                    <div class="bg-white/10 backdrop-blur px-4 py-2 rounded-lg flex items-center gap-2 border border-white/20">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/dc/True_Money_Wallet_Logo.svg/2560px-True_Money_Wallet_Logo.svg.png" class="h-6">
                        <span class="text-xs font-medium">Official Partner</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-slate-800">หมวดหมู่ทั้งหมด</h2>
                <span id="item-count" class="text-sm text-slate-500">กำลังโหลด...</span>
            </div>
            <div id="cat-scroll" class="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide select-none">
                <button class="loading-skeleton w-24 h-10 rounded-full"></button>
                <button class="loading-skeleton w-24 h-10 rounded-full"></button>
            </div>
        </div>

        <div id="items-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            </div>

        <div id="empty-state" class="hidden text-center py-20">
            <div class="inline-block p-4 rounded-full bg-slate-100 mb-4 text-slate-400 text-3xl">
                <i class="fas fa-box-open"></i>
            </div>
            <h3 class="text-lg font-medium text-slate-600">ไม่พบไอเทมที่ค้นหา</h3>
            <p class="text-slate-400 text-sm">ลองเปลี่ยนคำค้นหา หรือเลือกหมวดหมู่อื่น</p>
        </div>

    </main>

    <footer class="bg-white border-t border-slate-200 mt-auto">
        <div class="max-w-7xl mx-auto px-4 py-8 text-center sm:text-left sm:flex justify-between items-center">
            <p class="text-slate-500 text-sm">© 2024 RewardHub System. All rights reserved.</p>
            <div class="flex justify-center gap-4 mt-4 sm:mt-0 text-slate-400">
                <a href="#" class="hover:text-blue-600"><i class="fab fa-facebook"></i></a>
                <a href="#" class="hover:text-blue-600"><i class="fab fa-line"></i></a>
                <a href="#" class="hover:text-blue-600"><i class="fab fa-discord"></i></a>
            </div>
        </div>
    </footer>

    <div id="auth-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal('auth-modal')"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
            <div class="p-8">
                <h2 class="text-2xl font-bold text-center text-slate-800 mb-1">ยินดีต้อนรับ</h2>
                <p class="text-center text-slate-500 mb-6 text-sm">เข้าสู่ระบบเพื่อเริ่มแลกของรางวัล</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1">อีเมล</label>
                        <input type="email" id="l-email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1">รหัสผ่าน</label>
                        <input type="password" id="l-pass" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                    </div>
                    <button onclick="loginUser()" class="w-full btn-primary py-2.5 rounded-lg font-semibold shadow-lg shadow-blue-500/30">เข้าสู่ระบบ / สมัครสมาชิก</button>
                    <p class="text-xs text-center text-slate-400 mt-4">
                        *หากยังไม่มีบัญชี ระบบจะสร้างให้อัตโนมัติเมื่อกดเข้าสู่ระบบ
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="redeem-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-slate-900/75 transition-opacity" onclick="closeModal('redeem-modal')"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="relative h-40 bg-slate-100">
                    <img id="m-img" src="" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                    <button onclick="closeModal('redeem-modal')" class="absolute top-4 right-4 bg-white/20 hover:bg-white/40 rounded-full p-1 text-white transition">
                        <i class="fas fa-times w-6 h-6 flex items-center justify-center"></i>
                    </button>
                    <div class="absolute bottom-4 left-6 text-white">
                        <div class="text-xs font-medium bg-blue-600 px-2 py-0.5 rounded inline-block mb-1">FREE</div>
                        <h3 id="m-name" class="text-2xl font-bold leading-none shadow-black drop-shadow-md">Item Name</h3>
                    </div>
                </div>

                <div class="p-6">
                    <div id="m-quota-warning" class="hidden mb-4 bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm flex items-center gap-2 border border-red-100">
                        <i class="fas fa-exclamation-circle"></i> <span>คุณรับสิทธิ์ครบตามจำนวนที่กำหนดแล้ว</span>
                    </div>

                    <form id="dynamic-form" class="space-y-4">
                        </form>

                    <div class="mt-6 flex gap-3">
                        <button type="button" onclick="closeModal('redeem-modal')" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 font-medium transition">ยกเลิก</button>
                        <button type="button" onclick="submitRedeem()" id="confirm-redeem-btn" class="flex-1 btn-primary px-4 py-2 rounded-lg font-bold shadow-lg shadow-blue-500/20">ยืนยันรับของ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('history-modal')"></div>
        <div class="absolute top-0 right-0 h-full w-full max-w-sm bg-white shadow-2xl transform transition-transform duration-300 flex flex-col">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800">ประวัติการทำรายการ</h3>
                <button onclick="closeModal('history-modal')" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50">
                </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyABuBrdprpiN32ZD4cSCiSslkYbRfnWGgE", // Replace with your key
            authDomain: "namba-fe57a.firebaseapp.com",
            databaseURL: "https://namba-fe57a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "namba-fe57a",
            appId: "1:340416568750:web:bb0a58ee618978bc107c3f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let allItems = [];
        let allCategories = [];
        let currentCategory = 'all';
        let selectedItem = null;
        let userRequestCount = {}; // Map itemId -> count

        // --- AUTH SYSTEM ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                document.getElementById('login-btn').classList.add('hidden');
                document.getElementById('user-menu').classList.remove('hidden');
                document.getElementById('user-menu').classList.add('flex');
                document.getElementById('user-avatar').innerText = user.email.charAt(0).toUpperCase();
                closeModal('auth-modal');
                fetchUserHistory();
            } else {
                document.getElementById('login-btn').classList.remove('hidden');
                document.getElementById('user-menu').classList.add('hidden');
                document.getElementById('user-menu').classList.remove('flex');
            }
        });

        function loginUser() {
            const e = document.getElementById('l-email').value;
            const p = document.getElementById('l-pass').value;
            if(!e || !p) return alert("กรุณากรอกข้อมูลให้ครบ");
            
            auth.signInWithEmailAndPassword(e, p).catch(err => {
                if(err.code === 'auth/user-not-found') {
                    // Auto Register
                    auth.createUserWithEmailAndPassword(e, p).then(() => {
                        alert("สมัครสมาชิกสำเร็จ!");
                    }).catch(e => alert(e.message));
                } else {
                    alert("เกิดข้อผิดพลาด: " + err.message);
                }
            });
        }
        
        function logout() { auth.signOut(); }

        // --- DATA LOADING & RENDERING ---
        
        // 1. Load Categories
        db.ref('categories').on('value', snapshot => {
            allCategories = [];
            const scrollDiv = document.getElementById('cat-scroll');
            scrollDiv.innerHTML = `
                <button onclick="setCategory('all')" 
                    class="cat-btn flex-shrink-0 px-5 py-2 rounded-full text-sm font-medium transition border border-transparent
                    bg-blue-600 text-white shadow-md ring-2 ring-blue-600 ring-offset-2" id="btn-cat-all">
                    ทั้งหมด
                </button>
            `;
            
            snapshot.forEach(child => {
                const cat = { id: child.key, ...child.val() };
                allCategories.push(cat);
                scrollDiv.innerHTML += `
                    <button onclick="setCategory('${cat.id}')" 
                        class="cat-btn flex-shrink-0 px-5 py-2 rounded-full text-sm font-medium transition bg-white text-slate-600 border border-slate-200 hover:border-blue-300 hover:text-blue-600" id="btn-cat-${cat.id}">
                        ${cat.name}
                    </button>
                `;
            });
        });

        // 2. Load Items
        db.ref('items').on('value', snapshot => {
            allItems = [];
            snapshot.forEach(child => {
                allItems.push({ id: child.key, ...child.val() });
            });
            renderItems();
        });

        function renderItems(itemsToRender = null) {
            const grid = document.getElementById('items-grid');
            const data = itemsToRender || allItems;
            let filtered = data;

            // Filter by Category
            if (currentCategory !== 'all') {
                filtered = filtered.filter(i => i.category === currentCategory);
            }

            // Update UI
            grid.innerHTML = '';
            document.getElementById('item-count').innerText = `${filtered.length} รายการ`;

            if (filtered.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');

            filtered.forEach(item => {
                const limitText = item.limitPerUser ? `<span class="text-[10px] text-orange-500 bg-orange-50 px-1.5 py-0.5 rounded border border-orange-100">จำกัด ${item.limitPerUser} ครั้ง</span>` : '';
                
                grid.innerHTML += `
                    <div onclick="prepareRedeem('${item.id}')" class="item-card bg-white rounded-xl overflow-hidden cursor-pointer group relative">
                        <div class="h-40 overflow-hidden relative bg-slate-100">
                            <img src="${item.image || 'https://via.placeholder.com/300'}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                            <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-black/50 to-transparent opacity-60"></div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold text-slate-800 truncate mb-1 text-sm group-hover:text-blue-600 transition">${item.name}</h3>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded">FREE</span>
                                ${limitText}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // --- SEARCH SYSTEM ---
        function handleSearch(isMobile = false) {
            const query = isMobile ? document.getElementById('mobile-search').value : document.getElementById('global-search').value;
            const term = query.toLowerCase().trim();
            
            if (!term) {
                renderItems();
                return;
            }

            const results = allItems.filter(item => 
                item.name.toLowerCase().includes(term) || 
                (item.keywords && item.keywords.toLowerCase().includes(term))
            );
            renderItems(results);
        }

        function setCategory(catId) {
            currentCategory = catId;
            // Update Button Styles
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.className = "cat-btn flex-shrink-0 px-5 py-2 rounded-full text-sm font-medium transition bg-white text-slate-600 border border-slate-200 hover:border-blue-300 hover:text-blue-600";
            });
            const activeBtn = document.getElementById(`btn-cat-${catId}`);
            if(activeBtn) activeBtn.className = "cat-btn flex-shrink-0 px-5 py-2 rounded-full text-sm font-medium transition bg-blue-600 text-white shadow-md ring-2 ring-blue-600 ring-offset-2 border border-transparent";
            
            renderItems();
        }

        // --- REDEEM LOGIC & FORM BUILDER ---
        async function prepareRedeem(itemId) {
            if (!currentUser) {
                openModal('auth-modal');
                return;
            }

            const item = allItems.find(i => i.id === itemId);
            if (!item) return;
            selectedItem = item;

            // Check Quota
            let canRedeem = true;
            if (item.limitPerUser) {
                const userHistory = await db.ref('requests').orderByChild('uid').equalTo(currentUser.uid).once('value');
                let count = 0;
                userHistory.forEach(s => {
                    if (s.val().itemId === itemId && s.val().status !== 'rejected') count++;
                });
                if (count >= parseInt(item.limitPerUser)) canRedeem = false;
            }

            // UI Setup
            document.getElementById('m-name').innerText = item.name;
            document.getElementById('m-img').src = item.image;
            const warning = document.getElementById('m-quota-warning');
            const btn = document.getElementById('confirm-redeem-btn');
            const formContainer = document.getElementById('dynamic-form');
            formContainer.innerHTML = '';

            if (!canRedeem) {
                warning.classList.remove('hidden');
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                formContainer.innerHTML = '<p class="text-center text-slate-400">คุณไม่สามารถรับไอเทมนี้ได้อีก</p>';
            } else {
                warning.classList.add('hidden');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');

                // *** DYNAMIC FORM GENERATOR ***
                if (item.formFields && item.formFields.length > 0) {
                    item.formFields.forEach(field => {
                        let inputType = 'text';
                        if (field.type === 'number') inputType = 'number';
                        if (field.type === 'email') inputType = 'email';
                        
                        formContainer.innerHTML += `
                            <div>
                                <label class="block text-xs font-medium text-slate-700 mb-1">
                                    ${field.label} <span class="text-red-500">*</span>
                                </label>
                                <input type="${inputType}" data-label="${field.label}" class="dynamic-input w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition" placeholder="ระบุ ${field.label}">
                            </div>
                        `;
                    });
                } else {
                    formContainer.innerHTML = `
                        <div class="text-center py-4 bg-blue-50 rounded-lg border border-blue-100">
                            <p class="text-blue-600 text-sm font-medium">กดปุ่มยืนยันเพื่อรับของรางวัลได้ทันที</p>
                        </div>
                    `;
                }
            }

            openModal('redeem-modal');
        }

        function submitRedeem() {
            if(!selectedItem || !currentUser) return;

            const inputs = document.querySelectorAll('.dynamic-input');
            const formData = {};
            let isComplete = true;

            inputs.forEach(input => {
                const val = input.value.trim();
                if (!val) {
                    input.classList.add('border-red-500');
                    isComplete = false;
                } else {
                    input.classList.remove('border-red-500');
                    formData[input.dataset.label] = val;
                }
            });

            if (!isComplete) return alert('กรุณากรอกข้อมูลให้ครบถ้วน');

            // Send to Firebase
            const reqData = {
                uid: currentUser.uid,
                email: currentUser.email,
                itemId: selectedItem.id,
                itemName: selectedItem.name,
                itemImage: selectedItem.image,
                formData: formData,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref('requests').push(reqData).then(() => {
                alert('ส่งคำขอสำเร็จ! กรุณารอแอดมินตรวจสอบ');
                closeModal('redeem-modal');
                fetchUserHistory();
            }).catch(e => alert(e.message));
        }

        // --- HISTORY ---
        function fetchUserHistory() {
            if(!currentUser) return;
            db.ref('requests').orderByChild('uid').equalTo(currentUser.uid).limitToLast(20).on('value', s => {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                if(!s.exists()) {
                    list.innerHTML = '<div class="text-center text-slate-400 mt-10 text-sm">ยังไม่มีประวัติการแลกของ</div>';
                    return;
                }

                const arr = [];
                s.forEach(c => arr.push(c.val()));
                arr.reverse().forEach(req => {
                    let statusClass = 'bg-yellow-100 text-yellow-700';
                    let statusText = 'รอตรวจสอบ';
                    if(req.status === 'approved') { statusClass = 'bg-green-100 text-green-700'; statusText = 'สำเร็จ'; }
                    if(req.status === 'rejected') { statusClass = 'bg-red-100 text-red-700'; statusText = 'ถูกปฏิเสธ'; }

                    list.innerHTML += `
                        <div class="bg-white p-3 rounded-lg border border-slate-100 shadow-sm flex gap-3">
                            <img src="${req.itemImage}" class="w-10 h-10 rounded object-cover bg-slate-200">
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h4 class="font-semibold text-slate-800 text-sm truncate pr-2">${req.itemName}</h4>
                                    <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${statusClass}">${statusText}</span>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-0.5">${new Date(req.timestamp).toLocaleString('th-TH')}</p>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- UTILS ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>
